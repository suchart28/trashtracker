<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>รถเก็บขยะเทศบาลใกล้ฉัน</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">

<!-- Google Font Kanit -->
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body {
  margin:0;
  font-family: "Kanit", sans-serif;
  background:#ffffff;
}
#map {
  width:100vw;
  height:60vh;
}
#infoBox {
  text-align:center;
  padding:20px;
}
#etaText {
  font-size: 6vw;
  font-weight:600;
  color:#007bff;
}
#truckName {
  font-size: 10vw;
  font-weight:600;
  margin-top:10px;
}
.blink {
  animation: blink 1s infinite;
}
@keyframes blink {
  0% { opacity:1; }
  50% { opacity:0.3; }
  100% { opacity:1; }
}
</style>

</head>
<body>

<!-- ป้องกันการเปิดผ่าน LINE / FB -->
<script>
(function() {
  const ua = navigator.userAgent.toLowerCase();
  if(ua.includes("line") || ua.includes("fb") || ua.includes("instagram") || ua.includes("tiktok")) {
    document.body.innerHTML = `
      <div style="padding:30px; font-size:22px; text-align:center;">
        ⚠ กรุณาเปิดเว็บนี้ใน Chrome หรือ Safari เท่านั้น<br><br>
        <b>วิธีเปิด:</b><br>
        iPhone → กดปุ่มแชร์ → เปิดใน Safari<br>
        Android → กด ⋮ → เปิดใน Chrome
      </div>
    `;
  }
})();
</script>

<div id="map"></div>

<div id="infoBox">
  <div id="truckName">ค้นหารถใกล้คุณ...</div>
  <div id="etaText">—</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDGYuI3yxJbUTc6T_0pm6WiEKZul11tXS0",
    authDomain: "suchartwork-1487382986748.firebaseapp.com",
    databaseURL: "https://suchartwork-1487382986748.firebaseio.com",
    projectId: "suchartwork-1487382986748",
    storageBucket: "suchartwork-1487382986748.firebasestorage.app",
    messagingSenderId: "353884592527",
    appId: "1:353884592527:web:0d5f392910ab0d2ceb13fa"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// เรียกตำแหน่งบ้านผู้ใช้
let userLat = null, userLng = null;
navigator.geolocation.watchPosition(pos=>{
  userLat = pos.coords.latitude;
  userLng = pos.coords.longitude;
});

// Leaflet map
const map = L.map('map').setView([16.44,102.83], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// เก็บตำแหน่งรถ
let markers = {};
let paths = {};
let currentClosest = null;

// คำนวณระยะทาง
function distance(lat1,lng1,lat2,lng2){
  return Math.sqrt((lat1-lat2)**2 + (lng1-lng2)**2);
}

onValue(ref(db, "trucks"), snapshot=>{
  const data = snapshot.val();
  if(!data || !userLat) return;

  // เลือกเฉพาะรถที่มีชื่อและมีตำแหน่ง
  let valid = Object.entries(data).filter(([id,t])=>t && t.name && t.lat && t.lng);

  if(valid.length===0) return;

  // หาใกล้สุด
  valid.sort((a,b)=>{
    return distance(a[1].lat,a[1].lng,userLat,userLng) - distance(b[1].lat,b[1].lng,userLat,userLng);
  });

  const [closestID, truck] = valid[0];

  document.getElementById("truckName").textContent = truck.name;
  document.getElementById("etaText").textContent = "เวลาที่รถเก็บขยะจะมาถึง ≈ " + Math.round(distance(truck.lat,truck.lng,userLat,userLng)*50) + " นาที";

  // Marker รถ
  if(!markers[closestID]){
    markers[closestID] = L.marker([truck.lat,truck.lng]).addTo(map);
    markers[closestID]._icon.classList.add("blink");
  } else {
    markers[closestID].setLatLng([truck.lat,truck.lng]);
  }

  // วาดเส้นทาง
  if(!paths[closestID]){
    paths[closestID] = L.polyline([], {color:"#007bff", weight:4}).addTo(map);
  }
  paths[closestID].addLatLng([truck.lat,truck.lng]);

  map.setView([truck.lat,truck.lng], 15);
});
</script>

<!-- Wake Lock -->
<script>
let wakeLock = null;
async function enableWakeLock(){
  try { wakeLock = await navigator.wakeLock.request("screen"); }
  catch(e){}
}
document.addEventListener("click", enableWakeLock);
</script>

<!-- PWA Service Worker -->
<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>

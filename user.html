<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  />

  <!-- Kanit Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: "Kanit", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      background: #f4f6f9;
    }

    h1 {
      margin-top: 10px;
      font-size: 32px;
      font-weight: 600;
    }

    #map {
      width: 100%;
      height: 78vh;
      border-radius: 10px;
      margin-top: 10px;
    }

    #list {
      width: 100%;
      max-width: 480px;
      margin-top: 12px;
      padding: 10px;
      font-size: 18px;
      text-align: center;
    }

    .truck-item {
      background: white;
      padding: 10px;
      margin-bottom: 6px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>

<body>
  <h1>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•</h1>
  <div id="map"></div>
  <div id="list"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <script>
    // ‚úÖ Firebase Configuration (‡πÅ‡∏ó‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤)
    const firebaseConfig = {
      apiKey: "AIzaSyDGYuI3yxJbUTc6T_0pm6WiEKZul11tXS0",
      authDomain: "suchartwork-1487382986748.firebaseapp.com",
      databaseURL: "https://suchartwork-1487382986748.firebaseio.com",
      projectId: "suchartwork-1487382986748",
      storageBucket: "suchartwork-1487382986748.firebasestorage.app",
      messagingSenderId: "353884592527",
      appId: "1:353884592527:web:0d5f392910ab0d2ceb13fa"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const trucksRef = db.ref("trucks");

    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    const map = L.map("map").setView([16.4419, 102.8332], 13); // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ)

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(map);

    const markers = {};

    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡πÅ‡∏ö‡∏ö Real-time
    trucksRef.on("value", snapshot => {
      const data = snapshot.val();
      if (!data) return;

      const oneHourAgo = Date.now() - (60 * 60 * 1000);

      // ‡∏•‡∏ö‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ä‡∏°.
      Object.keys(data).forEach(key => {
        if (data[key].timestamp && data[key].timestamp < oneHourAgo) {
          trucksRef.child(key).remove();
        }
      });

      document.getElementById("list").innerHTML = "";

      Object.keys(data).forEach(id => {
        const t = data[id];

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï marker
        if (!markers[id]) {
          markers[id] = L.marker([t.lat, t.lng]).addTo(map);
        } else {
          markers[id].setLatLng([t.lat, t.lng]);
        }

        markers[id].bindPopup(`üöõ ‡∏£‡∏ñ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${id}`).openPopup();

        // ETA (‡∏á‡πà‡∏≤‡∏¢ ‡πÜ = ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
        const etaMinutes = Math.floor((Date.now() - t.timestamp) / 60000);

        document.getElementById("list").innerHTML += `
          <div class="truck-item">
            üöõ <b>‡∏£‡∏ñ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç ${id}</b><br>
            ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏ñ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏¢‡∏∞‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á: <b>${etaMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ</b>
          </div>
        `;
      });
    });
  </script>
</body>
</html>

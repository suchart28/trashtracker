<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>รถเก็บขยะเทศบาลใกล้ฉัน</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    body { margin:0; font-family: 'Kanit', sans-serif; text-align:center; background:black; color:white; }
    #map { width: 100vw; height: 60vh; }
    #etaBox { font-size: 3rem; padding: 20px; background:#111; }
    .marker-nearest {
      background: yellow;
      padding: 12px;
      border-radius: 10px;
      font-size: 1.8rem;
      font-weight: bold;
      animation: blink 1s infinite;
    }
    @keyframes blink { 50% { opacity: 0.4; } }
  </style>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">

</head>
<body>

  <h2>รถเก็บขยะเทศบาลใกล้ฉัน</h2>
  <div id="etaBox">กำลังค้นหาตำแหน่งของคุณ...</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGYuI3yxJbUTc6T_0pm6WiEKZul11tXS0",
      authDomain: "suchartwork-1487382986748.firebaseapp.com",
      databaseURL: "https://suchartwork-1487382986748.firebaseio.com",
      projectId: "suchartwork-1487382986748",
      storageBucket: "suchartwork-1487382986748.firebasestorage.app",
      messagingSenderId: "353884592527",
      appId: "1:353884592527:web:0d5f392910ab0d2ceb13fa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let userLat = null, userLon = null;

    const map = L.map('map').setView([15.0, 100.0], 14);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    let nearestMarker = null;
    let polyline = null;
    let polylinePoints = [];

    function haversine(lat1,lon1,lat2,lon2){
      const R = 6371;
      const dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    function updateNearest(trucks){
      if (!userLat || !userLon || trucks.length === 0) return;

      const nearest = trucks[0];
      const eta = Math.round(nearest.distance / 0.02);
      document.getElementById("etaBox").textContent = `รถ ${nearest.id} จะมาถึงใน ${eta} นาที`;

      const icon = L.divIcon({
        html:`<div class="marker-nearest">${nearest.id}</div>`,
        className:'', iconSize:[0,0]
      });

      if(nearestMarker){
        nearestMarker.setLatLng([nearest.lat,nearest.lon]).setIcon(icon);
      } else {
        nearestMarker = L.marker([nearest.lat,nearest.lon],{icon}).addTo(map);
      }

      polylinePoints.push([nearest.lat, nearest.lon]);
      if(polyline){
        polyline.setLatLngs(polylinePoints);
      } else {
        polyline = L.polyline(polylinePoints, { weight: 8, color: "#00ff55" }).addTo(map);
      }
    }

    navigator.geolocation.watchPosition(pos=>{
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      map.setView([userLat,userLon],15);
    });

    onValue(ref(db,"trucks/"), snap => {
      const data = snap.val() || {};
      const list = [];

      for(let id in data){
        const t = data[id];
        if(!id || !t.lat || !t.lon) continue;

        const dist = haversine(userLat,userLon,t.lat,t.lon);
        list.push({id,lat:t.lat,lon:t.lon,distance:dist});
      }

      list.sort((a,b)=>a.distance-b.distance);
      updateNearest(list);
    });

    // ✅ Wake Lock (หน้าจอติดสว่าง)
    let wakeLock;
    async function keepAwake(){
      try { wakeLock = await navigator.wakeLock.request("screen"); }
      catch(e){}
    }
    keepAwake();
    document.addEventListener("visibilitychange",()=>{ if(document.visibilityState==="visible") keepAwake(); });

  </script>
</body>
</html>

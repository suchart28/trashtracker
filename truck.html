<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>รถเก็บขยะเทศบาลใกล้ฉัน</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      text-align:center;
      font-family: 'Kanit', sans-serif;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:100vh;
    }

    #topPanel {
      flex: 0 0 40vh;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
    }

    #truckLabel {
      font-size: 4rem;
      font-weight: 700;
      background:#00ff55;
      color:#000;
      padding: 18px 34px;
      border-radius: 18px;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      50% { opacity: 0.45; }
    }

    #etaBox {
      font-size: 2.6rem;
      margin-top: 22px;
      font-weight: 400;
    }

    #map {
      flex: 1;
      width:100vw;
    }
  </style>

</head>
<body>

  <div id="topPanel">
    <div id="truckLabel" style="display:none;"></div>
    <div id="etaBox">กำลังค้นหาตำแหน่งของคุณ...</div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGYuI3yxJbUTc6T_0pm6WiEKZul11tXS0",
      authDomain: "suchartwork-1487382986748.firebaseapp.com",
      databaseURL: "https://suchartwork-1487382986748.firebaseio.com",
      projectId: "suchartwork-1487382986748",
      storageBucket: "suchartwork-1487382986748.firebasestorage.app",
      messagingSenderId: "353884592527",
      appId: "1:353884592527:web:0d5f392910ab0d2ceb13fa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let userLat, userLon;
    let nearestMarker = null;
    let polyline = null;
    let polylinePoints = [];

    const map = L.map('map').setView([13.736, 100.523], 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    function haversine(lat1,lon1,lat2,lon2){
      const R = 6371;
      const dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    function updateNearest(list){
      if (!userLat || !userLon || list.length === 0) return;

      const nearest = list[0];
      const eta = Math.round(nearest.distance / 0.02);

      document.getElementById("truckLabel").style.display = "inline-block";
      document.getElementById("truckLabel").textContent = nearest.id;
      document.getElementById("etaBox").textContent = `รถจะมาถึงใน ${eta} นาที`;

      const icon = L.divIcon({
        html:`<div style="background:#00ff55;padding:14px;border-radius:12px;font-weight:700;font-size:1.7rem;color:#000;animation:blink 1s infinite;">${nearest.id}</div>`,
        className:'',
        iconSize:[0,0]
      });

      if(nearestMarker){
        nearestMarker.setLatLng([nearest.lat,nearest.lon]).setIcon(icon);
      } else {
        nearestMarker = L.marker([nearest.lat,nearest.lon],{icon}).addTo(map);
      }

      polylinePoints.push([nearest.lat, nearest.lon]);
      if(polyline){
        polyline.setLatLngs(polylinePoints);
      } else {
        polyline = L.polyline(polylinePoints, { weight: 8, color: "#00ff55" }).addTo(map);
      }
    }

    navigator.geolocation.watchPosition(pos=>{
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;
      map.setView([userLat,userLon]);
    });

    onValue(ref(db,"trucks/"), snap => {
      const data = snap.val() || {};
      const list = [];

      for(let id in data){
        const t = data[id];
        if(!id || !t.lat || !t.lon) continue;
        list.push({id, lat:t.lat, lon:t.lon, distance:haversine(userLat,userLon,t.lat,t.lon)});
      }

      list.sort((a,b)=>a.distance-b.distance);
      updateNearest(list);
    });

    // ✅ Wake Lock Always Bright
    let wakeLock;
    async function keepAwake(){ try{ wakeLock = await navigator.wakeLock.request("screen"); }catch(e){} }
    keepAwake();
    document.addEventListener("visibilitychange",()=>{ if(document.visibilityState==="visible") keepAwake(); });

  </script>
</body>
</html>
